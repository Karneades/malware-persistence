A not yet so awesome list with only the links is found [separately](awesome-list.md). More detailed information is found below.

---

# Collection of malware persistence information

This repository collects various currently scattered information regarding the
detection, the response and the log collection of malware persistence
mechanisms.

In short, we look for one of the things which is so common between different
malware families: the ability to persist on a target host. Also malware
associated with the misleading term "fileless" often persists on the target
too, though not through regular files on the file system but through changes
in configuration files like Windows Registry or cron jobs.

Unfortunately, many malware blog posts include all the various IP and hash
information but only a few highlight the persistence mechanism from an attack,
despite that it's one of the more static and more difficult to change
information from an attacker's perspective. Using the persistence mechanism to
hunt for malware is more robust than the more frequently changed IP addresses
or hashes.

If you're only looking for an overview about persistence techniques and some
links to useful resources then see [overview of often and less often used persistence mechanisms](#overview-of-often-and-less-often-used-persistence-mechanisms) and [links and resources for detection](#links-and-resources-for-detection). See section [tools](#tools) for some well-known persistence collection tools.

This repository is regularly updated with new detection resources and tools.
If you have inputs then [pull requests](https://github.com/Karneades/malware-persistence/pulls) are more then welcome!

<!-- vim-markdown-toc GFM -->

* [Why bothering with malware persistence?](#why-bothering-with-malware-persistence)
* [Detection](#detection)
    * [Approach](#approach)
    * [Overview of often and less often used persistence mechanisms](#overview-of-often-and-less-often-used-persistence-mechanisms)
    * [Links and resources for detection](#links-and-resources-for-detection)
        * [MITRE ATT&CK tactic "TA0003 - Persistence"](#mitre-attck-tactic-ta0003---persistence)
        * [Hexacorn's blog persistence category](#hexacorns-blog-persistence-category)
        * [Forensic artifact repository](#forensic-artifact-repository)
        * [Sigma rules](#sigma-rules)
        * [Autoruns and KnockKnock](#autoruns-and-knockknock)
        * [Various blog posts](#various-blog-posts)
    * [Detection Evasion](#detection-evasion)
    * [Examples](#examples)
        * [MITRE ATT&CK persistence technique called Local Job Scheduling](#mitre-attck-persistence-technique-called-local-job-scheduling)
        * [(Ab)use of Rundll32](#abuse-of-rundll32)
* [Testing](#testing)
    * [Example](#example)
* [Response](#response)
* [Prevention](#prevention)
* [Tools](#tools)
    * [Linux](#linux)
    * [MacOS](#macos)
    * [Windows](#windows)
    * [Github topic search for persistence](#github-topic-search-for-persistence)
* [Acknowledgement](#acknowledgement)

<!-- vim-markdown-toc -->

## Why bothering with malware persistence?

If you are an incident responder and have to analyze compromised hosts, do a
generic compromise assessment or if you do threat hunting activities in your
infrastructure, then you should get into the topic of persistence mechanisms as
one way to detect known or unknown malware. It's one of the pieces for looking
for during IR activities.

Let's start with the [persistence
technique](https://attack.mitre.org/tactics/TA0003/) description used by
[MITRE](https://attack.mitre.org/):
>  The adversary is trying to maintain their foothold.
>
> Persistence consists of techniques that adversaries use to keep 
> access to systems across restarts, changed credentials, and other 
> interruptions that could cut off their access. Techniques used for 
> persistence include any access, action, or configuration changes that 
> let them maintain their foothold on systems, such as replacing or 
> hijacking legitimate code or adding startup code. 

One thing in common between different malware families is that they 
(mostly) try to persist on the target host. Malware associated with the
misleading term "fileless" often persists on the target too, though not through
regular files on the file system but through changes in configuration files
like Windows Registry or cron jobs.

Why use the word _mostly_ above? Because there is rare malware which omit
setting persistence mechanism on the victim's host itself but reinfect the host
after reboot from another system (e.g. DC, where the system is running longtime
on which no persistence is needed at all).

This gold mine of malware persistence information is a fraction of what other
log sources produce. Tens to hundreds of events depending of what you looking
for versus thousand to ten thousands of entries for process information.
Therefore, the analysis of these events reduce the time and the effort
compared to other log sources considerably. The signal to noise ratio is also
much lower.

So, by becoming and being a persistent persistence hunter, you can make use of
this treasury. Though not that kind of persistence hunting described in
[Wikipedia](https://en.wikipedia.org/wiki/Persistence_hunting)...
> Persistence hunting (sometimes called endurance hunting) is a hunting
> technique in which hunters, who may be slower than their prey over short
> distances, use a combination of running, walking, and tracking to pursue prey
> until it is exhausted. A persistence hunter must be able to run a long
> distance over an extended period of time. 

## Detection

While there are many ways how malware can persist on a host, malware authors
rely mostly on a handful of techniques. Beside these often used techniques
some malware families and more targeted attacks use more advanced mechanisms
to stay hidden on the system.

Keep in mind that for some persistence techniques escalated privileges are
required and therefore malware running under normal users (and privilege
escalation left out of consideration) can only set "user mode" persistence. So
if the user on the infected host only use a normal user account then first
focus on the user level persistence and secondly look for system level
techniques.

### Approach 

The analysis process could involve these steps, as with other incident
response and threat hunting procedures:
1. Collect the persistence mechanisms using single commands for specific
   techniques (see [links and resources for
   detection](#links-and-resources-for-detection)) or use tools for collection
   of a bunch of them at the same time, see [tools](#tools).
2. Analyse the command, file hash, file signer and file path information and
   enrich the information with more information from external services (AV
   detection rate, correlation with other files, reputation, signer
   information, known-bad hash check).
3. If the output doesn't help, check the information against other clients in your
   infrastructure: Is this entry found on other hosts too?
4. Look for anomalies, e.g. an exe file in startup folder where normally only
   .lnk files should be placed is suspicious or look for IP addresses or web
   request in cronjobs. See the links below for detection ideas.
5. In the process of the analysis it is important note too what is NOT found
   (evidence of absence) and not only what is found, e.g. no cron jobs were
   found at all.

### Overview of often and less often used persistence mechanisms

The used techniques varies from user land persistence mechanisms, to system
level persistence, from hiding behind common binary names, to putting malware
at unusual but lesser known places. Sometimes only a proxy or other network
configuration (i.a. DNS settings) changes were found after infection. Retefe used
the latter.

Use the information from section [links and resources for
detection](#links-and-resources-for-detection) for specific information for
these techniques.

1. Often used techniques:
    * Windows: registry run keys, scheduled tasks, services, startup folder.
    * Linux: startup, rc and init scripts, cron jobs, shell scripts, shell profiles.
    * MacOS: launch daemons and agents, startup items, shell scripts, shell profiles.

2. In-depth analysis should further include less frequently but still regularly
used techniques:
    * Windows: e.g. WMI implants, DLL side loading, malicious
      drivers, LNK files, sneaky way to get persistence through RDP
      connections on Windows is the use of image hijacks, sometimes known as
      "sticky keys hijacking" or known as technique "Accessibility Features" in
      the ATT&CK Matrix, COM Hijacking
    * Linux: e.g. malicious libraries, binary replacements or network scripts
    * MacOS: e.g. Dylib hijacking.
    * All OSes: Proxy and other network configuration changes, backdoor accounts
      and shortcut modifications.
    * Developers workstations: e.g. modified IDE software and git hook scripts.

Example of difficult to detect cases:
* Malware which omit setting persistence at all on the victim's host but
  reinfect the host after reboot from another system, e.g. from a DC (a system
  which is running longtime and no persistence is needed at all).
* Persistence, e.g. through registry run keys, is only set shortly before
  the shutdown command (shutdown command is hooked). Used in Dridex malware in
  the past. Cool thing, if you knew that, you could cold boot the computer and
  "deactivate" Dridex.
* Abuse of hooked file handler.
* DLL side loading (file can be anywhere on the system).
* Weak permissions which allows writing to folders from where binaries are executed.
* Legitimate binary replacement.
* Bootkits or modified kernel images can be e.g. detected by checking the
    signed binaries from the client.

### Links and resources for detection

The following resources cover a lot of persistence techniques and more
information on how to detect these specific mechanisms.

#### MITRE ATT&CK tactic "TA0003 - Persistence"

One of the most comprehensive lists of persistence techniques is the list
found in [MITRE ATT&CK tactic "TA0003 - Persistence"](https://attack.mitre.org/tactics/TA0003/).
Besides a description, different mitigations and a detection section is provided. Furthermore, the involved actors using these techniques are listed on the page.

URL: https://attack.mitre.org/tactics/TA0003/

#### Hexacorn's blog persistence category

A second gold mine for persistence information is found on [Hexacorn's
blog](http://www.hexacorn.com/blog/category/autostart-persistence/) where
regularly and since long time new techniques and blog posts about persistence
mechanisms are published, crazy stuff. You'll also find there the legendary
series "Beyond good ol’ Run key".

URL: http://www.hexacorn.com/blog/category/autostart-persistence/

#### Forensic artifact repository

The [forensic artifact
repository](https://github.com/ForensicArtifacts/artifacts) covers different
artifacts regarding persistence for different OSes. See yaml files for MacOS,
Linux and Windows in the
[data](https://github.com/ForensicArtifacts/artifacts/tree/master/data)
directory.

URL: https://github.com/ForensicArtifacts/artifacts

#### Sigma rules

[Sigma rules](https://github.com/Neo23x0/sigma/tree/master/rules) also include
various rules regarding persistence. [Search for persistence rules in Sigma
repository](https://github.com/Neo23x0/sigma/search?q=persistence&unscoped_q=persistence)
or use the filter options of Sigma for either MITRE ATT&CK persistence
category itself or for one specific technique:

```
sigmac --recurse --filter tag=attack.persistence --target splunk --config config/splunk-windows.yml rules

sigmac --recurse --filter tag=attack.t1084 --target splunk --config config/splunk-windows.yml rules
```

URL: https://github.com/Neo23x0/sigma/search?q=persistence&unscoped_q=persistence

#### Autoruns and KnockKnock

You can learn which Windows persistence mechanisms are possible by looking at
the output of Autoruns on your own client (see also [tools](#tools)). In the
output you see the categories and the different locations where things were
found. To see which entries Autoruns scans at all, you can start a
disassembler and look at the strings found in the binary, this covers only a
subset.

URL: http://technet.microsoft.com/en-us/sysinternals/bb963902

Another way to find Windows persistence information is to look at the [PowerShell implementation of Autoruns, where the
locations are found in the source code]( https://github.com/p0w3rsh3ll/AutoRuns/blob/master/AutoRuns.psm1). Bonus: A [history of the covered persistence locations for each version](https://github.com/p0w3rsh3ll/AutoRuns/blob/master/AutoRuns.psm1#L2824) is found there too, which is awesome!

URL:  https://github.com/p0w3rsh3ll/AutoRuns/blob/master/AutoRuns.psm1

For macOS there's the KnockKnock persistence tool to look for persistence mechanisms: https://github.com/objective-see/KnockKnock. Specific persistence locations are found in the [plugins](https://github.com/objective-see/KnockKnock/tree/main/Plugins) folder, e.g. [LaunchItems](https://github.com/objective-see/KnockKnock/blob/main/Plugins/LaunchItems.m#L21) or [StartupScripts](https://github.com/objective-see/KnockKnock/blob/main/Plugins/StartupScripts.m#L22).

#### Various blog posts

Various blog posts write about persistence mechanisms, some specific for one
technique, others for a broader set of techniques. Here are some for the past
years as an inspiration what to look for.
 
See [How malware persists on macOS](https://www.sentinelone.com/blog/how-malware-persists-on-macos/) for macOS persistence locations, General persistence mechanisms: [Common malware persistence mechanisms](https://resources.infosecinstitute.com/common-malware-persistence-mechanisms/), [Malware persistence techniques](https://www.andreafortuna.org/2017/07/06/malware-persistence-techniques/), WMI: [Detecting & Removing an Attacker’s WMI Persistence](https://medium.com/threatpunter/detecting-removing-wmi-persistence-60ccbb7dff96), Winlogon: [Windows Persistence using WinLogon](https://www.hackingarticles.in/windows-persistence-using-winlogon/), Kovter: [Untangling Kovter’s persistence methods](https://blog.malwarebytes.com/threat-analysis/2016/07/untangling-kovter/), [Threat Spotlight: Kovter Malware Fileless Persistence Mechanism](https://threatvector.cylance.com/en_us/home/threat-spotlight-kovter-malware-fileless-persistence-mechanism.html), GlobalFlags in Image File Execution Hijacks: [Persistence using GlobalFlags in Image File Execution Options – Hidden from Autoruns.exe](https://oddvar.moe/2018/04/10/persistence-using-globalflags-in-image-file-execution-options-hidden-from-autoruns-exe/), Bootloader persistence: [Uncovering a MyKings Variant With Bootloader Persistence via Managed Detection and Response](https://blog.trendmicro.com/trendlabs-security-intelligence/uncovering-a-mykings-variant-with-bootloader-persistence-via-managed-detection-and-response/), COM hijacking / CLSID hijacking: [gdatasoftware writeup from 2014](https://www.gdatasoftware.com/blog/2014/10/23941-com-object-hijacking-the-discreet-way-of-persistence) or [pentestlab writeup from 2020](https://pentestlab.blog/2020/05/20/persistence-com-hijacking/) or [Enigma0x3 / Matt Nelson's writeup from 2016 abusing com hijacking in combination with scheduled tasks](https://enigma0x3.net/2016/05/25/userland-persistence-with-scheduled-tasks-and-com-handler-hijacking/), Linux cron: [Linux Malware Persistence with Cron](https://www.sandflysecurity.com/blog/linux-malware-persistence-with-cron/).

### Detection Evasion

Malware authors abuse different techniques to hide their malware persistence
or make the detection more difficult:
* Rootkits hide files or hook registry queries
* Use similar or typosquatted names to OS default binary names 
* Hidding entries by abusing program bugs, like the one with the null byte in registry keys which results in error while collection or just missing entries in the output of tools
* [Abusing ADS (alternate data streams) in windows](https://argonsys.com/microsoft-cloud/library/latest-astaroth-living-off-the-land-attacks-are-even-more-invisible-but-not-less-observable/)
* Using DLL side-loading for well-known binaries
* Using signed binaries which then gets filtered out (depending on the analysis)

### Examples

#### MITRE ATT&CK persistence technique called Local Job Scheduling

In the list from the [tactic's
page](https://attack.mitre.org/tactics/TA0003/), we can navigate to the
technique itself, namely [T1168 - local job
scheduling](https://attack.mitre.org/techniques/T1168/) and get the
description and the needed information about the involved tools and files:

> On Linux and macOS systems, multiple methods are supported for creating pre-scheduled and periodic background jobs: cron, at, and launchd.
>
> [...]
>
> System-wide cron jobs are installed by modifying /etc/crontab file, /etc/cron.d/ directory or other locations supported by the Cron daemon, while per-user cron jobs are installed using crontab with specifically formatted crontab files.

Further below the detection ideas are provided. Besides the process monitoring
we can spot malicious jobs by comparing the cron files and commands against other hosts or
just search for unusual commands.

```
% grep -r http /etc/cron.daily/*
```

A writeup on bleepingcomputer regarding a [cryptominer on Linux](https://www.bleepingcomputer.com/news/security/cryptominer-uses-cron-to-reinfect-linux-host-after-removal/) shows an example of such a cron entry. IP changes but the persistence technique using the crontab and a web request stays. So hunt them down!

#### (Ab)use of Rundll32

A second example is the (ab)use of rundll32.exe to load a library through
registery keys or other means ([T1085 - Rundll32](https://attack.mitre.org/techniques/T1085/)). 
Ursnif is one of the malware families which use a specific rundll32 command
line since long time. Therefore, searching for registry keys containing
"rundll32" and "DllRegisterServer" in the command line would catch it or just
use "rundll32" as a more generic search pattern.

Example taken from Trendmicro's [URSNIF threat encyclopedia](https://www.trendmicro.com/vinfo/us/threat-encyclopedia/malware/trojanspy.win32.ursnif.tiaboecq)

```
In HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
    dminsenh = "rundll32 "%Application Data%\Microsoft\Appislad\devrusic.dll",DllRegisterServer"
```

## Testing

Use the descriptions and information from the resources in section
[detection](#detection) to simulate the persistence.

Furthermore, different tools provide checks to verify if detections work. For example, the
[Atomic Red Team](https://github.com/redcanaryco/atomic-red-team) test suite
allows checking for specific MITRE ATT&CK persistence techniques, see e.g. [T1044 "File
System Permissions
Weakness"](https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1044/T1044.yaml).

[hasherezade published demos](https://github.com/hasherezade/persistence_demos) of various 
(also non standard) persistence methods used by malware, like COM hijacking.

### Example

As an example we use the technique [T1183 - "Image File Execution Options Injection"](https://attack.mitre.org/techniques/T1183/) and abuse the "sticky keys" feature for executing a command shell. This would also be triggered before a login.

To test your collection tools, the prevention mechanisms in place and
your awesome detections, execute the following for adding a debugger value for the
corresponding registry key:

```
REG ADD "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe" /v Debugger /t REG_SZ /d "cmd /c tasklist"
```

Now you can click multiple times on the shift-key on your keyboard to trigger
the execution of cmd.

## Response

If you respond to an incident and need to clean up malware persistence as a
temporary countermeasure, you just have to remove the given information. For
files and configuration changes it's mostly done using standard OS commands.
Use your EDR or some other frameworks (e.g. for Windows, see [PowerSponse](https://github.com/swisscom/PowerSponse)).

In special cases like WMI the cleanup is not as straightforward as with
other mechanisms, see blog post [Removing Backdoors – Powershell Empire Edition](https://www.n00py.io/2017/01/removing-backdoors-powershell-empire-edition/):
1. remove the binding using `Get-WmiObject __FilterToConsumerBinding -Namespace root\subscription | Where-Object { $_.filter -match 'evil'} | Remove-WmiObject;`
1. remove the event consumer using `Get-WmiObject CommandLineEventConsumer -Namespace root\subscription -Filter "name='evil'" | Remove-WmiObject`
1. remove the event filter using `Get-WMIObject -Namespace root\Subscription -Class __EventFilter -Filter "Name='evil'" | Remove-WmiObject -Verbose`

Then there were issues with null byte values in the Windows registry and
attackers abused that to hide entries in e.g. run keys. Custom tools or the
[RegDelNull](https://docs.microsoft.com/en-us/sysinternals/downloads/regdelnull)
can be used to remove these entries.

## Prevention

This list is in no way comprehensive and just lists some possibilities to prevent malware persistence. The most important thing would be of course to prevent the execution of unknown programs.
* Block file writes to unusual places if possible, e.g. public user
    profile in Windows.
* Block file types on specific folders where only limited file types are used
    (e.g. .exe in startup folder where only .lnk files should be placed).
* Use file integrity checking on important config files (e.g. cronjobs).
* Reduce privileges so more advanced persistence techniques would fail due to
    missing privileges.
* File system permissions should be checked regularly and be as restricted as
    possible.
* Lock down configuration files (read-only) and on Windows put ACLs on
    specific registry keys (like for the accessibility features keys).
    
For macOS there's the BlockBlock tool by Patrick Wardle which provides protection by monitoring persistence locations: https://github.com/objective-see/BlockBlock.

## Tools

You can either collect the needed information once on a (remote) host in case of an incident or
collect the information on a regular basis for baselining and threat hunting.

One thing as a reminder and thanks to Harlan Carvey over at windowsir for
pointing out similar points too in various blog posts, see [Deep Knowledge,
and the Pursuit Thereof ](https://windowsir.blogspot.com/2019/05/deep-knowledge-and-pursuit-thereof.html)
and [Troubleshooting and Deep
Knowledge](https://windowsir.blogspot.com/2019/05/troubleshooting-and-deep-knowledge.html):
Be cautious of the results of tools and try to cross check with different
tools or check things by hand. Tools only provide you the information in their
way and sometimes miss the malicious entry or some options were turned off
etc. Autoruns for example can hide Microsoft signed entries, but than some
LOLbin (living-of-the-land, abusing system tools so to say) commands were
missing. Use it to reduce the amount of entries, but know the limits. There
was a null byte issue with the registry and the entries were
missing too in the collection. New version fixed the issue. One more: [Persistence using
GlobalFlags in Image File Execution Options – Hidden from Autoruns.exe](https://oddvar.moe/2018/04/10/persistence-using-globalflags-in-image-file-execution-options-hidden-from-autoruns-exe/).

For collection of specific techniques see [links and resources for
detection](#links-and-resources-for-detection) which cover detailed
information about the location of different persistence mechanisms.

### Linux

* I'm not aware of a public available tool to get a bunch of persistence mechanisms. But
    there are different commands which can be put into a script for easier
    usage. Depending on the distribution use the corresponding commands for
    `crontab`, `cat`, `grep`, `md5sum`, `sha1sum`, `sha256sum`, `somethingsum`
    and directory listings for most of the techniques.
* For regular collection of persistence mechanisms you can look into
  [osquery](https://osquery.readthedocs.io) or
  [OSSEC](https://github.com/ossec/ossec-hids).

### MacOS

* [KnockKnock](https://www.objective-see.com/products/knockknock.html)
  uncovers persistently installed software in order to generically
  reveal such malware. See [Github repository too for the source code](https://github.com/objective-see/KnockKnock).
* [BlockBlock](https://github.com/objective-see/BlockBlock) provides continual protection by monitoring persistence locations.
* [Dylib Hijack Scanner or DHS](https://www.objective-see.com/products/dhs.html), is a 
  simple utility that will scan your computer for applications that are either 
  susceptible to dylib hijacking or have been hijacked. See [Github repository too for the source code](https://github.com/objective-see/DylibHijackScanner).
* Besides the UI tool KnockKnock, I'm not aware of a public available command line tool
  to get a bunch of persistence mechanisms. But there are different commands which can be put
  into a script for easier usage. Use the corresponding commands for
  `crontab`, `cat`, `grep`, `md5sum`, `sha1sum`, `sha256sum`, `somethingsum`
  and directory listings for most of the techniques.
* For regular collection of persistence mechanisms you can look into
  [osquery](https://osquery.readthedocs.io) or
  [OSSEC](https://github.com/ossec/ossec-hids).

### Windows

* A powerful persistence collection tool on Windows is
  [Autoruns](http://technet.microsoft.com/en-us/sysinternals/bb963902). It
  collects different categories and persistence information from a live system and [in
  limited ways from offline images](https://www.sans.org/blog/offline-autoruns-revisited-auditing-malware-persistence/). There is a UI and a command line program
  and the output format can be set to CSV which can then be imported into your
  log collection system of choice.
* Instead of using CSV output and copy these file to the server, you can use
  the script [AutorunsToWinEventLog.ps1](https://github.com/palantir/windows-event-forwarding/blob/master/AutorunsToWinEventLog/AutorunsToWinEventLog.ps1) to convert the Autoruns output to Windows event
  logs and rely on standard Windows event log forwarding.
* There's also a PowerShell version of [Autoruns](https://github.com/p0w3rsh3ll/AutoRuns).
* [RegRipper](https://github.com/keydet89/RegRipper2.8) does also extracts
  various persistence mechanisms from the registry files directly.
* [RECmd](https://github.com/EricZimmerman/RECmd) using the config file [UserClassesASEPs](https://github.com/EricZimmerman/RECmd/blob/master/BatchExamples/UserClassesASEPs.reb) extracts user's CLSID information.
* Different AVs and EDR tools also include the detection and prevention of
  persistence mechanisms

### Github topic search for persistence

Currently not many things are found with these topics, but if you search for #malware and #persistence the matched repositories are listed: https://github.com/search?q=%23malware+%23persistence&type=

## Acknowledgement

Thanks to my employer [Swisscom](https://www.swisscom.ch)
([Github](https://github.com/swisscom)) for allowing me to publish the
information which was inspired by my work in the past few years at the
[@swisscom_csirt](https://twitter.com/swisscom_csirt).

