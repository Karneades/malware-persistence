# (Not so) Awesome Malware Persistence

This as an extract from the [main article about malware
persistence](README.md) only including the links to the resources and tools. A
not yet curated list of awesome malware persistence tools and resources. See
[README](README.md) for more detailed information on the topic.

<!-- vim-markdown-toc GFM -->

* [Techniques](#techniques)
* [Removal](#removal)
* [Detection Testing](#detection-testing)
* [Collection](#collection)
    * [Linux](#linux)
    * [MacOS](#macos)
    * [Windows](#windows)
    * [General](#general)
* [Contributing](#contributing)

<!-- vim-markdown-toc -->

## Techniques

_Persistence techniques and detection._

* [MITRE ATT&CK tactic "TA0003 - Persistence"](https://attack.mitre.org/tactics/TA0003/) - MITRE ATT&CK tactic "TA0003 - Persistence".
* [Hexacorn's
blog](http://www.hexacorn.com/blog/category/autostart-persistence/) - Hexacorn's blog category for persistence category including the series "Beyond good ol’ Run key".
* [theevilbit's series "Beyond the good ol' LaunchAgents"](https://theevilbit.github.io/tags/beyond/) - theevilbit's series about persistence on macOS beyond just the LaunchDaemons or LaunchAgents.
* [forensic artifact
repository](https://github.com/ForensicArtifacts/artifacts) - Forensic artifact repository covers persistence techniques in their artifacts.
* [Sigma rules](https://github.com/Neo23x0/sigma/tree/master/rules) - Sigma rules which covers persistence techniques. You can even use filters such as `--filter tag=attack.persistence` or specifically for one technique `tag=attack.t1084`.
* [Autoruns](http://technet.microsoft.com/en-us/sysinternals/bb963902) - You can learn which Windows persistence mechanisms are possible by looking at the output of Autoruns on your own client. In the output you see the categories and the different locations where things were found. To see which entries Autoruns scans at all, you can start a disassembler and look at the strings found in the binary, this covers only a
subset.
* [PowerShell implementation of Autoruns](https://github.com/p0w3rsh3ll/AutoRuns/blob/master/AutoRuns.psm1) - Another way to find Windows persistence locations is to look at the PowerShell source code. Bonus: A [history of the covered persistence locations for each Autoruns version](https://github.com/p0w3rsh3ll/AutoRuns/blob/master/AutoRuns.psm1#L2824) is found there too, which is so awesome!
* For macOS there's the [KnockKnock persistence detection tool](https://github.com/objective-see/KnockKnock) to look for persistence mechanisms. Specific persistence locations are found in the [plugins](https://github.com/objective-see/KnockKnock/tree/main/Plugins) folder, e.g. [LaunchItems](https://github.com/objective-see/KnockKnock/blob/main/Plugins/LaunchItems.m#L21) or [StartupScripts](https://github.com/objective-see/KnockKnock/blob/main/Plugins/StartupScripts.m#L22).
* [How malware persists on macOS](https://www.sentinelone.com/blog/how-malware-persists-on-macos/) - List of MacOS persistence mechanisms.
* [Common malware persistence mechanisms](https://resources.infosecinstitute.com/common-malware-persistence-mechanisms/) - General persistence mechanisms.
* [Malware persistence techniques](https://www.andreafortuna.org/2017/07/06/malware-persistence-techniques/) - General persistence mechanisms.
* Various blog posts -  WMI: [Detecting & Removing an Attacker’s WMI Persistence](https://medium.com/threatpunter/detecting-removing-wmi-persistence-60ccbb7dff96), Winlogon: [Windows Persistence using WinLogon](https://www.hackingarticles.in/windows-persistence-using-winlogon/), Kovter: [Untangling Kovter’s persistence methods](https://blog.malwarebytes.com/threat-analysis/2016/07/untangling-kovter/), [Threat Spotlight: Kovter Malware Fileless Persistence Mechanism](https://threatvector.cylance.com/en_us/home/threat-spotlight-kovter-malware-fileless-persistence-mechanism.html), GlobalFlags in Image File Execution Hijacks: [Persistence using GlobalFlags in Image File Execution Options – Hidden from Autoruns.exe](https://oddvar.moe/2018/04/10/persistence-using-globalflags-in-image-file-execution-options-hidden-from-autoruns-exe/), Bootloader persistence: [Uncovering a MyKings Variant With Bootloader Persistence via Managed Detection and Response](https://blog.trendmicro.com/trendlabs-security-intelligence/uncovering-a-mykings-variant-with-bootloader-persistence-via-managed-detection-and-response/), COM hijacking / CLSID hijacking: [gdatasoftware writeup from 2014](https://www.gdatasoftware.com/blog/2014/10/23941-com-object-hijacking-the-discreet-way-of-persistence) or [pentestlab writeup from 2020](https://pentestlab.blog/2020/05/20/persistence-com-hijacking/) or [Enigma0x3 / Matt Nelson's writeup from 2016 abusing com hijacking in combination with scheduled tasks](https://enigma0x3.net/2016/05/25/userland-persistence-with-scheduled-tasks-and-com-handler-hijacking/), Linux cron: [Linux Malware Persistence with Cron](https://www.sandflysecurity.com/blog/linux-malware-persistence-with-cron/), Microsoft Exchange and Outlook: [Hunting for persistence via Microsoft Exchange Server or Outlook](https://speakerdeck.com/heirhabarov/hunting-for-persistence-via-microsoft-exchange-server-or-outlook).

## Removal

_Tools and commands for removal of persistence mechanisms._

* Use standard OS commands to remove the persistence
* [PowerSponse](https://github.com/swisscom/PowerSponse) - PowerSponse includes various commands for cleanup of persistence mechanisms
* [Removing Backdoors – Powershell Empire Edition](https://www.n00py.io/2017/01/removing-backdoors-powershell-empire-edition/) - Various blog posts handle the removal of WMI implants
* [RegDelNull](https://docs.microsoft.com/en-us/sysinternals/downloads/regdelnull) - Removal of registry keys with null bytes - used e.g. in run keys for evasion

## Detection Testing

_Tools for testing detections._

* [Persistence Techniques](#persistence-techniques) - Use the technique to
    create these files or add the configuration changes by hand to test your
    detections.
* [Atomic Red Team](https://github.com/redcanaryco/atomic-red-team) - Atomic Red Team supports also the MITRE ATT&CK persistence techniques, see e.g. [T1044 "File System Permissions Weakness"](https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1044/T1044.yaml)
* [hasherezade published demos](https://github.com/hasherezade/persistence_demos) of various 
  (also non standard) persistence methods used by malware, like COM hijacking.

## Prevention

_Tools for preventing malicious persistence._

### macOS

* [BlockBlock](https://github.com/objective-see/BlockBlock) provides continual protection by monitoring persistence locations.

## Collection

_Tools for persistence collection._

### Linux

* I'm not aware of a public available tool to get a bunch of persistence mechanisms.
* Use OS commands which can be put into a script for easier usage: `crontab`, `cat`, `grep`, `md5sum`, `sha1sum`, `sha256sum`, `somethingsum` and directory listings.
* For regular collection of persistence mechanisms you can look into
  [osquery](https://osquery.readthedocs.io) or
  [OSSEC](https://github.com/ossec/ossec-hids).

### macOS

* [KnockKnock](https://www.objective-see.com/products/knockknock.html) - KnockKnock uncovers persistently installed software in order to generically reveal such malware. See [Github repository too for the source code](https://github.com/objective-see/KnockKnock).
* [Dylib Hijack Scanner or DHS](https://www.objective-see.com/products/dhs.html), is a 
  simple utility that will scan your computer for applications that are either 
  susceptible to dylib hijacking or have been hijacked. See [Github repository too for the source code](https://github.com/objective-see/DylibHijackScanner).
* Besides the UI tool KnockKnock, I'm not aware of a public available command line tool
  to get a bunch of persistence mechanisms.
* Use OS ommands which can be put into a script for easier usage. Use the corresponding commands for
  `crontab`, `cat`, `grep`, `md5sum`, `sha1sum`, `sha256sum`, `somethingsum` and directory listings for most of the techniques.
* For regular collection of persistence mechanisms you can look into
  [osquery](https://osquery.readthedocs.io) or
  [OSSEC](https://github.com/ossec/ossec-hids).

### Windows

* [Autoruns](http://technet.microsoft.com/en-us/sysinternals/bb963902) - A powerful persistence collection tool on Windows is Autoruns. It collects different categories and persistence information from a live system and [in
  limited ways from offline images](https://www.sans.org/blog/offline-autoruns-revisited-auditing-malware-persistence/). There is a UI and a command line program and the output format can be set to CSV which can then be imported into your log collection system of choice
* [AutorunsToWinEventLog.ps1](https://github.com/palantir/windows-event-forwarding/blob/master/AutorunsToWinEventLog/AutorunsToWinEventLog.ps1) - Instead of using CSV output and copy these file to the server, you can use the AutorunsToWinEventLog script to convert the Autoruns output to Windows event logs and rely on standard Windows event log forwarding
* [PowerShell Autoruns](https://github.com/p0w3rsh3ll/AutoRuns) - There's also a PowerShell version of Autoruns
* [RegRipper](https://github.com/keydet89/RegRipper2.8) - RegRipper does also extracts various persistence mechanisms from the registry files directly.
* [RECmd](https://github.com/EricZimmerman/RECmd) using the config file [UserClassesASEPs](https://github.com/EricZimmerman/RECmd/blob/master/BatchExamples/UserClassesASEPs.reb) extracts user's CLSID information.
* [KAPE](https://www.kroll.com/en/insights/publications/cyber/kroll-artifact-parser-extractor-kape) has different targets and modules, see [KapeFiles](https://github.com/EricZimmerman/KapeFiles) which include persistence mechanisms, among others there's a collection of [LNK files](https://github.com/EricZimmerman/KapeFiles/blob/master/Targets/Windows/LNKFilesAndJumpLists.tkape), [scheduled task files](https://github.com/EricZimmerman/KapeFiles/blob/master/Targets/Windows/ScheduledTasks.tkape) and [scheduled task listing](https://github.com/EricZimmerman/KapeFiles/blob/master/Modules/LiveResponse/schtasks.mkape) or a [WMI repository auditing](https://github.com/EricZimmerman/KapeFiles/blob/master/Modules/LiveResponse/WMI-Repository-Auditing.mkape) module.

### General

* [Github topic search for persistence](https://github.com/search?q=%23malware+%23persistence&type=) - Github search for #malware and #persistence for listing the matched repositories.

## Contributing

Pull requests are more than welcome. Add the link here and add a corresponding
section in the [README](README.md) with more detailed information.
